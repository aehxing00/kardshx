<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>KARDS: æˆ˜ç«é£äº‘</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #e0d6c5;
            --card-border: #1a1a1a;
            
            /* é˜µè¥é¢œè‰² */
            --germany-color: #263238; /* å¾·å›½ç° */
            --japan-color: #b71c1c;   /* æ—¥æœ¬çº¢ */
            --neutral-color: #5d4037; /* ç¾¤é›„/ä¸­ç«‹ */
            
            --highlight: #ffd700;
            --text-color: #e0e0e0;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            --hero-border: #ffd700;
            --soldier-border: #333;
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            user-select: none;
            height: 100vh;
            width: 100vw;
        }

        /* å¼ºåˆ¶æ¨ªå±æç¤º */
        #orientation-warning {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #fff;
        }
        
        @media screen and (orientation: portrait) {
            #orientation-warning { display: flex; }
        }

        #game-container {
            display: flex;
            height: 100%;
            width: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9"100%" filter="url(%23noise)"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/><feColorMatrix type="matrix" values="0 0 0 0 0.1 0 0 0 0 0.1 0 0 0 0 0.1 0 0 0 1 0"/></filter><rect width="100%" height="100%" fill="transparent"/></svg>'), radial-gradient(circle at center, #2c2c2c 0%, #000 100%);
        }

        /* === å·¦ä¾§è¾¹æ  (HQ & Info) === */
        #sidebar {
            flex: 0 0 240px;
            background: rgba(0,0,0,0.6);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 15px;
            z-index: 20;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
        }

        .hq-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%);
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #444;
            text-align: center;
            position: relative;
        }
        
        .hq-box.opponent-hq { border-top: 4px solid var(--germany-color); }
        .hq-box.player-hq { border-bottom: 4px solid var(--japan-color); }

        .hq-avatar {
            width: 70px; height: 70px;
            border-radius: 50%;
            background: #333;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            border: 3px solid #555;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        .hq-hp {
            font-size: 2.5em;
            color: #d32f2f;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
            margin: 5px 0;
        }
        
        .hq-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .controls-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .kredits-display {
            font-size: 1.8em;
            color: var(--highlight);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px 20px;
            border-radius: 4px;
            border: 1px solid #444;
            font-family: 'Courier New', monospace;
        }
        
        .kredit-dot {
            width: 12px; height: 12px;
            background: var(--highlight);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--highlight);
        }
        
        .deck-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        #end-turn-btn {
            background: linear-gradient(to bottom, #d4af37, #b59020);
            color: #1a1a1a;
            border: none;
            padding: 15px 0;
            width: 100%;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 0 #8a6d15;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.1s;
        }
        #end-turn-btn:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: none;
        }
        #end-turn-btn:disabled {
            background: #444;
            color: #888;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* === å³ä¾§ä¸»åŒºåŸŸ === */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* æ•Œæ–¹æ‰‹ç‰Œ */
        #opponent-hand-area {
            flex: 0 0 100px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10px;
        }
        
        /* æˆ˜åœº */
        #battlefield {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px;
            padding: 10px 60px;
            perspective: 1200px;
        }

        .row {
            height: 150px;
            border: 2px dashed rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            transition: background 0.3s;
            position: relative;
        }
        
        .row-label {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            color: rgba(255,255,255,0.2);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 2px;
        }
        
        #frontline {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(212, 175, 55, 0.2);
        }
        #frontline::after {
            content: "FRONTLINE";
            position: absolute;
            font-size: 40px;
            font-weight: 900;
            color: rgba(255,255,255,0.03);
            pointer-events: none;
            z-index: 0;
        }

        /* ç©å®¶æ‰‹ç‰Œ */
        #player-hand-area {
            flex: 0 0 180px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            z-index: 10;
        }

        /* === å¡ç‰Œæ ·å¼ === */
        .card {
            width: 120px;
            height: 168px; /* 5:7 ratio */
            background-color: var(--card-bg);
            border: 2px solid var(--soldier-border);
            border-radius: 6px;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            flex-shrink: 0;
            user-select: none;
            overflow: hidden;
        }
        
        .card.rarity-hero {
            border: 3px solid var(--hero-border);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* å¾·å›½é£æ ¼ */
        .card.germany { background-color: #cfd8dc; border-color: var(--germany-color); }
        .card.germany.rarity-hero { border-color: var(--hero-border); }
        .card.germany .card-header { background: var(--germany-color); color: #fff; }
        
        /* æ—¥æœ¬é£æ ¼ */
        .card.japan { background-color: #ffcdd2; border-color: var(--japan-color); }
        .card.japan.rarity-hero { border-color: var(--hero-border); }
        .card.japan .card-header { background: var(--japan-color); color: #fff; }
        
        /* ä¸­ç«‹/ç¾¤é›„é£æ ¼ */
        .card.neutral { background-color: #d7ccc8; border-color: var(--neutral-color); }
        .card.neutral.rarity-hero { border-color: var(--hero-border); }
        .card.neutral .card-header { background: var(--neutral-color); color: #fff; }

        /* æ‰‹ç‰Œå æ”¾ */
        #player-hand-area .card {
            margin-right: -50px;
            transform-origin: bottom center;
        }
        #player-hand-area .card:last-child { margin-right: 0; }
        #player-hand-area .card:hover {
            transform: translateY(-40px) scale(1.1) rotate(0deg) !important;
            z-index: 100;
            margin-right: 20px;
            margin-left: 20px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.8);
        }
        #player-hand-area .card.selected {
            transform: translateY(-50px) scale(1.15) !important;
            box-shadow: 0 0 20px var(--highlight);
            z-index: 101;
            border-color: var(--highlight);
        }

        /* æˆ˜åœºå•ä½ - ç®€åŒ–ç‰ˆå¡ç‰Œ */
        .unit-card {
            width: 100px;
            height: 130px;
            font-size: 0.9em;
        }
        .unit-card.exhausted { filter: grayscale(0.8) brightness(0.6); }
        .unit-card.ready { box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5); }
        
        .card-cost {
            position: absolute;
            top: 4px; left: 4px;
            width: 24px; height: 24px;
            background: #fff;
            color: #000;
            border-radius: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 900;
            border: 1px solid #000;
            z-index: 5;
            font-size: 14px;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .card-img {
            flex: 1;
            background: #555;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 40px;
            overflow: hidden;
            border-bottom: 2px solid rgba(0,0,0,0.2);
            position: relative;
        }
        
        .card-header {
            font-size: 11px;
            text-align: center;
            font-weight: bold;
            padding: 4px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-body {
            padding: 5px;
            height: 50px;
            background: rgba(255,255,255,0.5);
            color: #000;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
        }
        
        .card-type-tag {
            font-size: 8px;
            color: #555;
            margin-bottom: 2px;
            text-transform: uppercase;
        }

        .card-stats {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        .stat-atk { color: #ffb74d; text-shadow: 1px 1px 0 #000; }
        .stat-def { color: #64b5f6; text-shadow: 1px 1px 0 #000; }

        /* ç‰¹æ•ˆå›¾æ ‡ */
        .traits-row {
            position: absolute;
            top: 30px; right: 4px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            pointer-events: none;
        }
        .trait-icon {
            width: 22px; height: 22px;
            border-radius: 50%;
            border: 2px solid #fff;
            color: #fff;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            text-transform: uppercase;
        }
        .t-blitz { background: #ff8f00; content: "B"; }
        .t-guard { background: #546e7a; content: "G"; }
        .t-heavy { background: #0277bd; content: "A"; }
        .t-ambush { background: #7b1fa2; content: "H"; }
        .t-smoke { background: #757575; content: "S"; }
        .t-flight { background: #0288d1; content: "F"; }

        /* å¼¹çª—ä¸å¸®åŠ© */
        #help-btn {
            position: fixed;
            top: 15px; right: 15px;
            width: 30px; height: 30px;
            background: #333;
            color: #ccc;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            border: 1px solid #666;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        #help-btn:hover { opacity: 1; }

        /* æ¶ˆæ¯æç¤º */
        #msg-overlay {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 20px 40px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2000;
            border: 2px solid var(--highlight);
            text-align: center;
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 900px) {
            #sidebar { flex: 0 0 160px; padding: 10px; }
            .hq-avatar { width: 50px; height: 50px; font-size: 24px; }
            .hq-hp { font-size: 1.8em; }
            .row { height: 110px; }
            .card { width: 85px; height: 119px; }
            .unit-card { width: 80px; height: 110px; }
            #player-hand-area { height: 130px; }
            .card-body { font-size: 8px; height: 40px; padding: 2px; }
            .card-header { font-size: 9px; }
            .card-stats { font-size: 12px; padding: 3px 6px; }
            .kredits-display { font-size: 1.2em; padding: 5px 10px; }
            #end-turn-btn { padding: 10px 0; font-size: 14px; }
        }
        
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: #222;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            color: #ddd;
            border: 1px solid #555;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px; right: 10px;
            font-size: 24px;
            cursor: pointer;
        }
        h2, h3 { color: var(--highlight); border-bottom: 1px solid #444; padding-bottom: 10px; }
        
    </style>
</head>
<body>

<div id="orientation-warning">
    <div style="font-size: 40px; margin-bottom: 20px;">ğŸ“±â†”ï¸</div>
    <p>è¯·æ—‹è½¬è®¾å¤‡è‡³æ¨ªå±æ¨¡å¼ä»¥è·å¾—æœ€ä½³ä½“éªŒ</p>
</div>

<div id="game-container">
    <div id="help-btn" onclick="showHelp()">?</div>

    <!-- å·¦ä¾§æ  -->
    <div id="sidebar">
        <!-- æ•Œæ–¹HQ -->
        <div class="hq-box opponent-hq">
            <div class="hq-avatar" style="border-color:var(--germany-color)">ğŸ‡©ğŸ‡ª</div>
            <div class="hq-name">å¾·å›½ (GER)</div>
            <div class="hq-hp" id="opp-hp">20</div>
            <div class="deck-info">DECK: <span id="opp-deck-count">0</span></div>
            <div class="kredits-display">
                <div class="kredit-dot"></div>
                <span id="opp-kredits">1</span>/<span id="opp-kredits-max">12</span>
            </div>
        </div>

        <!-- ä¸­æ§ -->
        <div class="controls-area">
            <div style="flex:1"></div>
            <button id="end-turn-btn" onclick="endTurn()">ç»“æŸå›åˆ</button>
            <div class="kredits-display" style="background:#000">
                <div class="kredit-dot"></div>
                <span id="player-kredits">1</span>/<span id="player-kredits-max">12</span>
            </div>
            <div style="flex:1"></div>
        </div>

        <!-- æˆ‘æ–¹HQ -->
        <div class="hq-box player-hq">
            <div class="hq-avatar" style="border-color:var(--japan-color)">ğŸ‡¯ğŸ‡µ</div>
            <div class="hq-name">æ—¥æœ¬ (JPN)</div>
            <div class="hq-hp" id="player-hp">20</div>
            <div class="deck-info">DECK: <span id="player-deck-count">0</span></div>
        </div>
    </div>

    <!-- ä¸»åŒºåŸŸ -->
    <div id="main-area">
        <!-- æ•Œæ–¹æ‰‹ç‰Œ -->
        <div id="opponent-hand-area">
            <!-- JS å¡«å…… -->
        </div>

        <!-- æˆ˜åœº -->
        <div id="battlefield">
            <div id="opp-support" class="row">
                <div class="row-label">SUPPORT</div>
            </div>
            <div id="frontline" class="row">
                <div class="row-label">FRONTLINE</div>
            </div>
            <div id="player-support" class="row">
                <div class="row-label">SUPPORT</div>
            </div>
        </div>

        <!-- ç©å®¶æ‰‹ç‰Œ -->
        <div id="player-hand-area">
            <!-- JS å¡«å…… -->
        </div>
    </div>
</div>

<div id="help-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-close" onclick="hideHelp()">&times;</div>
        <h2>KARDS: æˆ˜ç«é£äº‘</h2>
        <p><strong>èƒœåˆ©æ¡ä»¶ï¼š</strong> æ‘§æ¯æ•Œæ–¹å¤§æœ¬è¥ (HQ)ã€‚</p>
        <p><strong>å‰çº¿æœºåˆ¶ï¼š</strong> åªæœ‰å æ®ä¸­é—´çš„å‰çº¿ï¼Œæ™®é€šå•ä½æ‰èƒ½æ”»å‡»æ•Œæ–¹HQã€‚</p>
        <hr>
        <h3>åŠ¿åŠ›ç‰¹è‰²</h3>
        <p><strong style="color:var(--japan-color)">æ—¥æœ¬ (JPN)</strong>: <strong>é€Ÿæ”»ã€æ¯ç­ã€ç‰ç¢</strong>ã€‚åˆ©ç”¨ä½è´¹å•ä½å¿«é€ŸæŠ¢è¡€ï¼Œæˆ–é€šè¿‡è‡ªæ¯é€ æˆå·¨é¢ä¼¤å®³ã€‚</p>
        <p><strong style="color:var(--germany-color)">å¾·å›½ (GER)</strong>: <strong>é—ªå‡»ã€é‡ç”²ã€æ§åˆ¶</strong>ã€‚åˆ©ç”¨é«˜è´¨é‡å¦å…‹æ§åˆ¶æˆ˜åœºï¼Œé…åˆæˆ˜æœ¯æŒ‡ä»¤æ‰“å‡»æ•Œäººã€‚</p>
        <hr>
        <h3>å¡ç‰Œç­‰çº§</h3>
        <p><strong>è‹±é›„å¡ (é‡‘è¾¹)</strong>: ä¼ å¥‡å•ä½æˆ–æŒ‡ä»¤ï¼Œå¡ç»„é™å¸¦1å¼ ã€‚</p>
        <p><strong>å£«å…µå¡</strong>: æ™®é€šä½œæˆ˜å•ä½ã€‚</p>
    </div>
</div>

<div id="msg-overlay"></div>

<script>
// === 1. å¡ç‰Œæ•°æ®åº“ (WWII Theme) ===
const CARDS = [
    // --- æ—¥æœ¬ (Japan) - Aggro/Destruction ---
    // è‹±é›„å¡
    { id: 'jp_hero_1', name: 'å±±æœ¬äº”åå…­', nation: 'japan', rarity: 'hero', type: 'unit', cost: 6, op: 1, atk: 5, def: 5, traits: [], text: 'éƒ¨ç½²ï¼šæ‰€æœ‰å‹å†›è·å¾—+1æ”»å‡»åŠ›', onDeploy: 'buff_all_1_atk', img: 'âš“' },
    { id: 'jp_hero_2', name: 'å±±ä¸‹å¥‰æ–‡', nation: 'japan', rarity: 'hero', type: 'unit', cost: 5, op: 1, atk: 6, def: 4, traits: ['ambush'], text: 'ä¼å‡», éƒ¨ç½²ï¼šæ¶ˆç­ä¸€ä¸ªå—æŸå•ä½', onDeploy: 'kill_damaged', img: 'ğŸ¯' },
    
    // å£«å…µå¡
    { id: 'jp_1', name: 'å…³ä¸œå†›æ­¥å…µ', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 1, op: 1, atk: 2, def: 1, traits: [], text: 'äº¡è¯­ï¼šå¯¹æ•Œæ–¹HQé€ æˆ1ç‚¹ä¼¤å®³', img: 'ğŸ’‚' },
    { id: 'jp_2', name: 'ä¹äº”å¼å¦å…‹', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 2, op: 1, atk: 3, def: 1, traits: ['blitz'], text: 'é—ªå‡»', img: 'ğŸšœ' },
    { id: 'jp_3', name: 'é›¶å¼æˆ˜æœº', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 3, op: 1, atk: 4, def: 2, traits: ['blitz', 'flight'], text: 'é—ªå‡», é£è¡Œ', img: 'âœˆï¸' },
    { id: 'jp_4', name: 'æ•¢æ­»é˜Ÿ', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 1, op: 0, atk: 4, def: 1, traits: [], text: 'å›åˆç»“æŸæ—¶è‡ªæ¯', onEndTurn: 'self_destruct', img: 'ğŸ’£' },
    { id: 'jp_5', name: 'ä¸‡å²å†²é”‹', nation: 'japan', rarity: 'soldier', type: 'order', cost: 2, effect: 'buff_all_2_0_temp', text: 'æœ¬å›åˆæ‰€æœ‰å‹å†›+2æ”»å‡»', img: 'ğŸš©' },
    { id: 'jp_6', name: 'å¸å›½å‘½ä»¤', nation: 'japan', rarity: 'soldier', type: 'order', cost: 1, effect: 'dmg_2_hq', text: 'å¯¹æ•Œæ–¹HQé€ æˆ2ç‚¹ä¼¤å®³', img: 'ğŸ“œ' },
    { id: 'jp_7', name: 'å¤§å’Œé­‚', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 4, op: 1, atk: 3, def: 4, traits: ['guard'], text: 'å®ˆæŠ¤', img: 'ğŸ›¡ï¸' },
    { id: 'jp_8', name: 'ä»™å°è”é˜Ÿ', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 2, op: 1, atk: 2, def: 3, traits: [], text: 'éƒ¨ç½²ï¼šæŠ½1å¼ ç‰Œ', onDeploy: 'draw_1', img: 'ğŸŒ²' },
    { id: 'jp_9', name: 'ç‰ç¢', nation: 'japan', rarity: 'soldier', type: 'order', cost: 3, effect: 'kill_unit_dmg_hq', text: 'æ¶ˆç­ä¸€ä¸ªå‹å†›ï¼Œå¯¹æ•Œæ–¹HQé€ æˆ5ç‚¹ä¼¤å®³', img: 'ğŸ’¥' },
    { id: 'jp_10', name: 'æ‰©å¼ ', nation: 'japan', rarity: 'soldier', type: 'order', cost: 2, effect: 'ramp_1', text: 'å¢åŠ 1ç‚¹ä»¤ä¸Šé™', img: 'ğŸ“ˆ' },
    { id: 'jp_11', name: 'ä¸€å¼é™†æ”»', nation: 'japan', rarity: 'soldier', type: 'unit', cost: 4, op: 2, atk: 5, def: 3, traits: ['flight'], text: 'é£è¡Œ', img: 'ğŸ›©ï¸' },

    // --- å¾·å›½ (Germany) - Tank/Control ---
    // è‹±é›„å¡
    { id: 'de_hero_1', name: 'åŸƒå°”æ¸©Â·éš†ç¾å°”', nation: 'germany', rarity: 'hero', type: 'unit', cost: 7, op: 1, atk: 5, def: 7, traits: ['heavy_armor', 'blitz'], text: 'é‡ç”²1, é—ªå‡», éƒ¨ç½²ï¼šå‰çº¿æ‰€æœ‰å•ä½+2æ”»å‡»', onDeploy: 'buff_front_2', img: 'ğŸ¦Š' },
    { id: 'de_hero_2', name: 'æµ·å› èŒ¨Â·å¤å¾·é‡Œå®‰', nation: 'germany', rarity: 'hero', type: 'unit', cost: 6, op: 1, atk: 4, def: 6, traits: ['blitz'], text: 'é—ªå‡», éƒ¨ç½²ï¼šä½¿ä¸€ä¸ªè£…ç”²å•ä½è·å¾—é‡ç”²', onDeploy: 'buff_armor_1', img: 'âš¡' },

    // å£«å…µå¡
    { id: 'de_1', name: 'å›½é˜²å†›æ­¥å…µ', nation: 'germany', rarity: 'soldier', type: 'unit', cost: 1, op: 1, atk: 1, def: 2, traits: ['guard'], text: 'å®ˆæŠ¤', img: 'ğŸ’‚' },
    { id: 'de_2', name: 'ä¸‰å·çªå‡»ç‚®', nation: 'germany', rarity: 'soldier', type: 'unit', cost: 3, op: 1, atk: 3, def: 4, traits: ['heavy_armor'], text: 'é‡ç”²1', img: 'ğŸšœ' },
    { id: 'de_3', name: 'é—ªç”µæˆ˜', nation: 'germany', rarity: 'soldier', type: 'order', cost: 2, effect: 'op_refresh', text: 'ä½¿ä¸€ä¸ªå•ä½é‡ç½®è¡ŒåŠ¨', img: 'âš¡' },
    { id: 'de_4', name: 'è™å¼å¦å…‹', nation: 'germany', rarity: 'soldier', type: 'unit', cost: 6, op: 2, atk: 6, def: 6, traits: ['heavy_armor'], text: 'é‡ç”²1', img: 'ğŸ…' },
    { id: 'de_5', name: 'æ–¯å›¾å¡è½°ç‚¸', nation: 'germany', rarity: 'soldier', type: 'order', cost: 3, effect: 'dmg_3', text: 'é€ æˆ3ç‚¹ä¼¤å®³', img: 'ğŸ’£' },
    { id: 'de_6', name: 'è±¹å¼å¦å…‹', nation: 'germany', rarity: 'soldier', type: 'unit', cost: 5, op: 1, atk: 5, def: 4, traits: ['blitz'], text: 'é—ªå‡»', img: 'ğŸ†' },
    { id: 'de_7', name: 'é“åå­—å‹‹ç« ', nation: 'germany', rarity: 'soldier', type: 'order', cost: 2, effect: 'buff_2_2', text: 'ä½¿ä¸€ä¸ªå•ä½+2/+2', img: 'ğŸ–ï¸' },
    { id: 'de_8', name: 'ç‹¼ç¾¤æˆ˜æœ¯', nation: 'germany', rarity: 'soldier', type: 'unit', cost: 2, op: 1, atk: 2, def: 2, traits: ['ambush'], text: 'ä¼å‡»', img: 'ğŸº' },
    { id: 'de_9', name: 'æ©å°¼æ ¼ç›', nation: 'germany', rarity: 'soldier', type: 'order', cost: 3, effect: 'draw_2', text: 'æŠ½2å¼ ç‰Œ', img: 'ğŸ“ ' },
    { id: 'de_10', name: 'æˆ˜æœ¯æ’¤é€€', nation: 'germany', rarity: 'soldier', type: 'order', cost: 1, effect: 'bounce_unit', text: 'å°†ä¸€ä¸ªå•ä½ç§»å›æ‰‹ç‰Œå¹¶å®Œå…¨ä¿®å¤', img: 'â†©ï¸' },
    { id: 'de_11', name: 'Bf 109', nation: 'germany', rarity: 'soldier', type: 'unit', cost: 3, op: 1, atk: 4, def: 2, traits: ['flight', 'blitz'], text: 'é£è¡Œ, é—ªå‡»', img: 'ğŸ¦…' },

    // --- ç¾¤é›„/ä¸­ç«‹ (Warlords/Neutral) ---
    // è‹±é›„å¡
    { id: 'neu_hero_1', name: 'é›‡ä½£å…µå›¢é•¿', nation: 'neutral', rarity: 'hero', type: 'unit', cost: 5, op: 1, atk: 4, def: 5, traits: [], text: 'éƒ¨ç½²ï¼šé€ æˆ2ç‚¹ä¼¤å®³', onDeploy: 'dmg_2_any', img: 'ğŸ¤ ' },
    
    // å£«å…µå¡
    { id: 'neu_1', name: 'æ„å¤§åˆ©å¿—æ„¿å†›', nation: 'neutral', rarity: 'soldier', type: 'unit', cost: 1, op: 1, atk: 1, def: 4, traits: [], text: 'åšéŸ§', img: 'ğŸ' },
    { id: 'neu_2', name: 'æŠµæŠ—ç»„ç»‡', nation: 'neutral', rarity: 'soldier', type: 'unit', cost: 2, op: 1, atk: 3, def: 1, traits: ['ambush'], text: 'ä¼å‡»', img: 'âœŠ' },
    { id: 'neu_3', name: 'è¡¥ç»™è½¦é˜Ÿ', nation: 'neutral', rarity: 'soldier', type: 'unit', cost: 3, op: 1, atk: 1, def: 5, traits: [], text: 'å›åˆå¼€å§‹ï¼šæ¢å¤HQ 2è¡€', onStartTurn: 'heal_hq_2', img: 'ğŸšš' },
    { id: 'neu_4', name: 'ç„¦åœŸæ”¿ç­–', nation: 'neutral', rarity: 'soldier', type: 'order', cost: 4, effect: 'kill_all_damaged', text: 'æ¶ˆç­æ‰€æœ‰å—æŸå•ä½', img: 'ğŸ”¥' }
];

// === 2. æ¸¸æˆçŠ¶æ€ ===
const state = {
    turn: 1,
    current: 'player', // 'player' | 'opponent'
    gameOver: false,
    
    player: {
        id: 'player', hp: 20, kredits: 1, maxKredits: 1,
        deck: [], hand: [], support: [], faction: 'japan'
    },
    opponent: {
        id: 'opponent', hp: 20, kredits: 1, maxKredits: 1,
        deck: [], hand: [], support: [], faction: 'germany'
    },
    frontline: {
        controller: null, // 'player' | 'opponent' | null
        units: []
    },
    
    selection: null // { type: 'hand'|'unit', item: obj }
};

// === 3. æ ¸å¿ƒé€»è¾‘ ===

function initGame() {
    state.player.deck = buildDeck('japan', ['neutral']);
    state.opponent.deck = buildDeck('germany', ['neutral']);
    
    shuffle(state.player.deck);
    shuffle(state.opponent.deck);
    
    draw(state.player, 4);
    draw(state.opponent, 4);
    
    render();
    showMsg("WAR BEGINS");
}

function buildDeck(main, allies) {
    const deck = [];
    const mainCards = CARDS.filter(c => c.nation === main);
    const allyCards = CARDS.filter(c => allies.includes(c.nation));
    
    // 1. è‹±é›„å¡ (é™1, éšæœº)
    const heroes = mainCards.filter(c => c.rarity === 'hero');
    if(heroes.length > 0) deck.push(clone(rand(heroes)));
    
    // 2. å¡«å……å…¶ä»–å¡ (å…±30å¼ )
    const soldiers = [...mainCards.filter(c => c.rarity !== 'hero'), ...allyCards.filter(c => c.rarity !== 'hero')];
    
    while(deck.length < 30) {
        deck.push(clone(rand(soldiers)));
    }
    
    return deck;
}

function clone(obj) { return JSON.parse(JSON.stringify(obj)); }
function rand(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function draw(player, count) {
    for(let i=0; i<count; i++) {
        if(player.deck.length > 0 && player.hand.length < 9) {
            const card = player.deck.pop();
            card.uid = Math.random().toString(36).substr(2, 9);
            player.hand.push(card);
        }
    }
}

function endTurn() {
    if(state.gameOver) return;
    state.selection = null;
    
    // å¤„ç†å›åˆç»“æŸæ•ˆæœ
    const endingPlayer = state.current === 'player' ? state.player : state.opponent;
    handleEndTurnEffects(endingPlayer);
    
    // åˆ‡æ¢
    state.current = state.current === 'player' ? 'opponent' : 'player';
    const active = state.current === 'player' ? state.player : state.opponent;
    
    // èµ„æºå¢é•¿
    if(active.maxKredits < 12) active.maxKredits++;
    active.kredits = active.maxKredits;
    
    // æŠ½ç‰Œ
    draw(active, 1);
    
    // é‡ç½®å•ä½çŠ¶æ€ & å›åˆå¼€å§‹æ•ˆæœ
    [state.player.support, state.opponent.support, state.frontline.units].forEach(list => {
        list.forEach(u => {
            u.moves = 0; u.attacks = 0; u.deployedTurn = false;
        });
    });
    handleStartTurnEffects(active);
    
    render();
    
    if(state.current === 'opponent') {
        setTimeout(aiTurn, 1000);
    }
}

function handleEndTurnEffects(player) {
    const allUnits = [...player.support];
    if(state.frontline.controller === player.id) allUnits.push(...state.frontline.units);
    
    allUnits.forEach(u => {
        if(u.onEndTurn === 'self_destruct') {
            u.currentHp = 0;
            showMsg(`${u.name} è‡ªæ¯!`);
        }
        
        // ç§»é™¤ä¸´æ—¶Buff
        if(u.tempBuffs) {
            u.tempBuffs.forEach(b => {
                if(b.atk) u.atk -= b.atk;
            });
            u.tempBuffs = [];
        }
    });
    checkDeaths();
}

function handleStartTurnEffects(player) {
    const allUnits = [...player.support];
    if(state.frontline.controller === player.id) allUnits.push(...state.frontline.units);
    
    allUnits.forEach(u => {
        if(u.onStartTurn === 'heal_hq_2') {
            player.hp = Math.min(20, player.hp + 2);
            showMsg("è¡¥ç»™åˆ°è¾¾");
        }
    });
}

// === äº¤äº’é€»è¾‘ ===

function handleCardClick(card, inHand, ownerId) {
    if(state.gameOver || state.current !== 'player') return;
    if(ownerId !== 'player') return;

    if(inHand) {
        if(state.selection?.item === card) {
            state.selection = null;
        } else {
            state.selection = { type: 'hand', item: card };
        }
    } else {
        const unit = card;
        if(state.selection?.item === unit) {
            state.selection = null;
        } else {
            state.selection = { type: 'unit', item: unit };
        }
    }
    render();
}

function handleTargetClick(targetType, targetId) {
    if(!state.selection || state.current !== 'player') return;
    
    const sel = state.selection;
    
    if(sel.type === 'hand') {
        const card = sel.item;
        if(card.cost > state.player.kredits) {
            showMsg("KREDITS ä¸è¶³ï¼");
            return;
        }
        
        if(card.type === 'unit') {
            if(targetType === 'zone' && targetId === 'player-support') {
                if(state.player.support.length >= 4) {
                    showMsg("åæ’å·²æ»¡");
                    return;
                }
                playUnit(state.player, card);
            }
        } else if(card.type === 'order') {
            playOrder(state.player, card, targetType, targetId);
        }
    } else if(sel.type === 'unit') {
        const unit = sel.item;
        if(targetType === 'zone' && targetId === 'frontline') {
            tryMoveFront(state.player, unit);
        } else if(targetType === 'unit' || targetType === 'hq') {
            tryAttack(state.player, unit, targetType, targetId);
        }
    }
}

function playUnit(player, card) {
    player.kredits -= card.cost;
    player.hand = player.hand.filter(c => c !== card);
    
    const unit = { ...card, currentHp: card.def, moves: 0, attacks: 0, deployedTurn: true };
    player.support.push(unit);
    
    if(unit.onDeploy) resolveDeployEffect(player, unit);
    
    state.selection = null;
    render();
}

function resolveDeployEffect(player, unit) {
    const isPlayer = player.id === 'player';
    const enemy = isPlayer ? state.opponent : state.player;
    
    if(unit.onDeploy === 'draw_1') {
        draw(player, 1);
    } else if(unit.onDeploy === 'dmg_2_any') {
        // ç®€å•åŒ–ï¼šæ‰“éšæœºæ•Œäººæˆ–HQ
        enemy.hp -= 2;
        showMsg(`${unit.name} é€ æˆ2ç‚¹ä¼¤å®³`);
    } else if(unit.onDeploy === 'buff_all_1_atk') {
        [...player.support, ...state.frontline.units].forEach(u => {
            if(getUnitOwner(u) === player.id) u.atk += 1;
        });
        showMsg("å±±æœ¬äº”åå…­: å…¨å†›çªå‡»!");
    } else if(unit.onDeploy === 'buff_front_2') {
        if(state.frontline.controller === player.id) {
            state.frontline.units.forEach(u => u.atk += 2);
            showMsg("å‰çº¿å¼ºåŒ–!");
        }
    } else if(unit.onDeploy === 'kill_damaged') {
        const enemySupport = player.id === 'player' ? state.opponent.support : state.player.support;
        const enemyFront = state.frontline.controller !== player.id ? state.frontline.units : [];
        const targets = [...enemySupport, ...enemyFront].filter(u => u.currentHp < u.def);
        
        if(targets.length > 0) {
            const target = targets[Math.floor(Math.random()*targets.length)]; // rand() not in scope? It is global.
            target.currentHp = 0;
            showMsg(`${unit.name} æ–©æ€ ${target.name}!`);
        } else {
            showMsg("æ— å—æŸæ•Œå†›");
        }
    } else if(unit.onDeploy === 'buff_armor_1') {
        const mySupport = player.id === 'player' ? state.player.support : state.opponent.support;
        const myFront = state.frontline.controller === player.id ? state.frontline.units : [];
        // Buff a random ally unit that doesn't have heavy armor? Or just any?
        // Text says "Give an armored unit Heavy Armor". Wait, "Armored unit" is not a type.
        // Let's assume it buffs a random ally unit with Heavy Armor +1?
        // The card text says: "ä½¿ä¸€ä¸ªè£…ç”²å•ä½è·å¾—é‡ç”²".
        // Let's simplify: Give a random ally unit Heavy Armor.
        const targets = [...mySupport, ...myFront].filter(u => u !== unit);
        if(targets.length > 0) {
            const target = targets[Math.floor(Math.random()*targets.length)];
            if(!target.traits.includes('heavy_armor')) target.traits.push('heavy_armor');
            showMsg(`${target.name} è·å¾—é‡ç”²!`);
        }
    }
}

function playOrder(player, card, targetType, targetObj) {
    let executed = false;
    const isPlayer = player.id === 'player';
    const enemy = isPlayer ? state.opponent : state.player;

    if(card.effect === 'dmg_3') {
        if(targetType === 'hq' && targetObj === (isPlayer?'opponent':'player')) {
            enemy.hp -= 3; executed = true;
        } else if(targetType === 'unit' && getUnitOwner(targetObj) !== player.id) {
            targetObj.currentHp -= 3; executed = true;
        }
    } else if(card.effect === 'dmg_2_hq') {
        enemy.hp -= 2; executed = true;
    } else if(card.effect === 'buff_2_2') {
        if(targetType === 'unit' && getUnitOwner(targetObj) === player.id) {
            targetObj.atk += 2; targetObj.currentHp += 2; targetObj.def += 2; executed = true;
        }
    } else if(card.effect === 'draw_2') {
        draw(player, 2); executed = true;
    } else if(card.effect === 'ramp_1') {
        player.maxKredits = Math.min(12, player.maxKredits+1); player.kredits++; executed = true;
    } else if(card.effect === 'kill_unit_dmg_hq') {
        if(targetType === 'unit' && getUnitOwner(targetObj) === player.id) {
            targetObj.currentHp = 0;
            enemy.hp -= 5;
            executed = true;
        } else {
             if(isPlayer) showMsg("é€‰æ‹©å·±æ–¹å•ä½çŒ®ç¥­");
        }
    } else if(card.effect === 'buff_all_2_0_temp') {
        [...player.support, ...state.frontline.units].forEach(u => {
            if(getUnitOwner(u) === player.id) {
                u.atk += 2;
                if(!u.tempBuffs) u.tempBuffs = [];
                u.tempBuffs.push({atk: 2});
            }
        });
        executed = true;
    }

    if(executed) {
        player.kredits -= card.cost;
        player.hand = player.hand.filter(c => c !== card);
        state.selection = null;
        render();
        checkDeaths();
        checkWin();
    } else {
        if(isPlayer) showMsg("æ— æ•ˆç›®æ ‡");
    }
}

function tryMoveFront(player, unit) {
    if(unit.op > player.kredits) { showMsg("KREDITS ä¸è¶³"); return; }
    if(unit.moves > 0 || (unit.deployedTurn && !unit.traits.includes('blitz'))) { showMsg("æ— æ³•ç§»åŠ¨"); return; }
    
    if(state.frontline.units.includes(unit)) { showMsg("å·²åœ¨å‰çº¿"); return; }
    if(state.frontline.controller && state.frontline.controller !== player.id) { showMsg("å‰çº¿è¢«æ•Œå†›å æ®"); return; }
    
    player.kredits -= unit.op;
    player.support = player.support.filter(u => u !== unit);
    state.frontline.units.push(unit);
    state.frontline.controller = player.id;
    unit.moves = 1;
    state.selection = null;
    render();
}

function tryAttack(player, unit, targetType, target) {
    if(unit.op > player.kredits) { showMsg("KREDITS ä¸è¶³"); return; }
    if(unit.attacks > 0) { showMsg("å·²æ”»å‡»è¿‡"); return; }
    if(unit.deployedTurn && !unit.traits.includes('blitz')) { showMsg("å‡†å¤‡ä¸­"); return; }
    
    const enemyFront = state.frontline.controller === (player.id==='player'?'opponent':'player') && state.frontline.units.length > 0;
    const amIFront = state.frontline.units.includes(unit);
    
    if(enemyFront && !amIFront) {
        // å¿…é¡»å…ˆæ‰“å‰çº¿ï¼Œé™¤éé£è¡Œå•ä½
        if(targetType === 'hq' || !state.frontline.units.includes(target)) {
            if(!unit.traits.includes('flight')) {
                showMsg("å‰çº¿å—é˜»");
                return;
            }
        }
    }
    
    // å®ˆæŠ¤
    if(targetType === 'unit') {
        const owner = getUnitOwner(target);
        let zoneUnits = (state.frontline.units.includes(target)) ? state.frontline.units : (owner === 'player' ? state.player.support : state.opponent.support);
        const guards = zoneUnits.filter(u => u.traits.includes('guard') && u !== target);
        if(guards.length > 0 && !target.traits.includes('guard')) {
            showMsg("è¢«å®ˆæŠ¤å•ä½é˜»æŒ¡");
            return;
        }
    } else if(targetType === 'hq') {
        // å¦‚æœæ²¡æœ‰å‰çº¿é˜»æŒ¡ï¼Œæ£€æŸ¥åæ’å®ˆæŠ¤
        if(!enemyFront) {
            const enemySupportGuards = (player.id==='player' ? state.opponent.support : state.player.support).filter(u => u.traits.includes('guard'));
            if(enemySupportGuards.length > 0) {
                showMsg("æ•Œæ–¹åæ’æœ‰å®ˆæŠ¤å•ä½");
                return;
            }
        }
    }

    player.kredits -= unit.op;
    unit.attacks = 1;
    
    if(targetType === 'hq') {
        const enemy = player.id === 'player' ? state.opponent : state.player;
        enemy.hp -= unit.atk;
        showMsg(`ğŸ’¥ -${unit.atk}`);
    } else {
        let dmgToTarget = unit.atk;
        let dmgToSelf = target.atk;
        
        if(target.traits.includes('heavy_armor')) dmgToTarget = Math.max(0, dmgToTarget - 1);
        if(unit.traits.includes('heavy_armor')) dmgToSelf = Math.max(0, dmgToSelf - 1);
        if(unit.traits.includes('ambush')) dmgToSelf = 0;
        
        target.currentHp -= dmgToTarget;
        unit.currentHp -= dmgToSelf;
    }
    
    state.selection = null;
    checkDeaths();
    render();
    checkWin();
}

function getUnitOwner(unit) {
    if(state.player.support.includes(unit)) return 'player';
    if(state.opponent.support.includes(unit)) return 'opponent';
    if(state.frontline.units.includes(unit)) return state.frontline.controller;
    return null;
}

function checkDeaths() {
    [state.player.support, state.opponent.support, state.frontline.units].forEach((list) => {
        for(let i=list.length-1; i>=0; i--) {
            if(list[i].currentHp <= 0) list.splice(i, 1);
        }
    });
    if(state.frontline.units.length === 0) state.frontline.controller = null;
}

function checkWin() {
    if(state.opponent.hp <= 0) { state.gameOver = true; showMsg("VICTORY!", 5000); }
    else if(state.player.hp <= 0) { state.gameOver = true; showMsg("DEFEAT...", 5000); }
}

// === AI ===
function aiTurn() {
    if(state.gameOver) return;
    const ai = state.opponent;
    const player = state.player;
    
    // 1. éƒ¨ç½²
    const playables = ai.hand.filter(c => c.type === 'unit' && c.cost <= ai.kredits);
    playables.sort((a,b) => b.cost - a.cost);
    
    if(playables.length > 0 && ai.support.length < 4) {
        playUnit(ai, playables[0]);
    }
    
    // 2. ç§»åŠ¨æŠ¢å‰çº¿
    if(!state.frontline.controller || state.frontline.controller === 'opponent') {
        const movers = ai.support.filter(u => u.op <= ai.kredits && u.moves === 0 && (!u.deployedTurn || u.traits.includes('blitz')));
        if(movers.length > 0) tryMoveFront(ai, movers[0]);
    }
    
    // 3. æ”»å‡»
    let attackers = [...ai.support];
    if(state.frontline.controller === 'opponent') attackers.push(...state.frontline.units);
    
    attackers.forEach(u => {
        if(u.op <= ai.kredits && u.attacks === 0 && (!u.deployedTurn || u.traits.includes('blitz'))) {
            // ç®€å•AIï¼šèƒ½æ‰“è„¸æ‰“è„¸
             const playerFront = state.frontline.controller === 'player' && state.frontline.units.length > 0;
             const amIFront = state.frontline.units.includes(u);
             
             if(playerFront && !amIFront) {
                 if(u.traits.includes('flight')) {
                     tryAttack(ai, u, 'hq', player);
                 } else {
                     tryAttack(ai, u, 'unit', state.frontline.units[0]);
                 }
             } else {
                 tryAttack(ai, u, 'hq', player);
             }
        }
    });
    
    checkDeaths();
    checkWin();
    render();
    
    setTimeout(endTurn, 1000);
}

// === æ¸²æŸ“ ===
function render() {
    document.getElementById('player-hp').textContent = state.player.hp;
    document.getElementById('player-kredits').textContent = state.player.kredits;
    document.getElementById('player-kredits-max').textContent = state.player.maxKredits;
    document.getElementById('player-deck-count').textContent = state.player.deck.length;
    
    document.getElementById('opp-hp').textContent = state.opponent.hp;
    document.getElementById('opp-kredits').textContent = state.opponent.kredits;
    document.getElementById('opp-kredits-max').textContent = state.opponent.maxKredits;
    document.getElementById('opp-deck-count').textContent = state.opponent.deck.length;

    renderHand(state.player.hand, 'player-hand-area', true);
    renderHand(state.opponent.hand, 'opponent-hand-area', false);
    
    renderZone(state.player.support, 'player-support');
    renderZone(state.opponent.support, 'opp-support');
    renderZone(state.frontline.units, 'frontline');
    
    document.getElementById('end-turn-btn').disabled = state.current !== 'player';
}

function renderHand(hand, containerId, isPlayer) {
    const el = document.getElementById(containerId);
    el.innerHTML = '';
    hand.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = `card ${card.nation} rarity-${card.rarity}`;
        if(isPlayer && state.selection?.item === card) cardEl.classList.add('selected');
        
        if(isPlayer) {
            cardEl.innerHTML = `
                <div class="card-cost">${card.cost}</div>
                <div class="card-img">${card.img}</div>
                <div class="card-header">${card.name}</div>
                <div class="card-body">
                    <div class="card-type-tag">${card.rarity === 'hero' ? 'â­ HERO' : 'SOLDIER'}</div>
                    ${card.text || ''}
                </div>
                ${card.type === 'unit' ? `<div class="card-stats"><span class="stat-atk">${card.atk}</span><span class="stat-def">${card.def}</span></div>` : ''}
            `;
            cardEl.onclick = (e) => { e.stopPropagation(); handleCardClick(card, true, 'player'); };
        } else {
            cardEl.style.background = '#3e2723';
            cardEl.style.width = '60px';
            cardEl.style.borderColor = '#1a1a1a';
            cardEl.innerHTML = `<div style="width:100%;height:100%;background:repeating-linear-gradient(45deg,#3e2723,#3e2723 10px,#4e342e 10px,#4e342e 20px)"></div>`;
        }
        el.appendChild(cardEl);
    });
}

function renderZone(units, containerId) {
    const el = document.getElementById(containerId);
    // ä¿ç•™label
    const label = el.querySelector('.row-label');
    el.innerHTML = '';
    if(label) el.appendChild(label);
    
    units.forEach(u => el.appendChild(createUnitEl(u)));
    
    if(state.selection?.type === 'hand' && state.selection.item.type === 'unit') {
        if(containerId === 'player-support' && units.length < 4) {
            el.onclick = () => handleTargetClick('zone', 'player-support');
            el.style.backgroundColor = 'rgba(255,255,255,0.05)';
        }
    } else {
        el.onclick = null;
        el.style.backgroundColor = '';
    }
    
    if(containerId === 'frontline') {
         el.onclick = () => handleTargetClick('zone', 'frontline');
    }
}

function createUnitEl(unit) {
    const el = document.createElement('div');
    el.className = `card unit-card ${unit.nation} rarity-${unit.rarity}`;
    if(unit.currentHp < unit.def) el.style.borderColor = 'red';
    if(unit.attacks > 0 || unit.moves > 0) el.classList.add('exhausted');
    if(state.selection?.item === unit) el.classList.add('selected');
    
    let traitsHtml = '';
    if(unit.traits.includes('blitz')) traitsHtml += '<span class="trait-icon t-blitz">B</span>';
    if(unit.traits.includes('guard')) traitsHtml += '<span class="trait-icon t-guard">G</span>';
    if(unit.traits.includes('heavy_armor')) traitsHtml += '<span class="trait-icon t-heavy">A</span>';
    if(unit.traits.includes('ambush')) traitsHtml += '<span class="trait-icon t-ambush">H</span>';
    if(unit.traits.includes('flight')) traitsHtml += '<span class="trait-icon t-flight">F</span>';
    
    el.innerHTML = `
        <div class="card-cost" style="width:20px;height:20px;font-size:12px">${unit.op}</div>
        <div class="card-img" style="height:45%">${unit.img}</div>
        <div class="card-header" style="font-size:10px">${unit.name}</div>
        <div class="traits-row">${traitsHtml}</div>
        <div class="card-stats">
            <span class="stat-atk">${unit.atk}</span>
            <span class="stat-def">${unit.currentHp}</span>
        </div>
    `;
    el.onclick = (e) => { 
        e.stopPropagation(); 
        const owner = getUnitOwner(unit);
        if(owner === 'player') {
             handleCardClick(unit, false, 'player');
        } else {
             handleTargetClick('unit', unit);
        }
    };
    return el;
}

function showMsg(txt, dur=1500) {
    const el = document.getElementById('msg-overlay');
    el.textContent = txt;
    el.style.opacity = 1;
    setTimeout(() => el.style.opacity = 0, dur);
}

function showHelp() { document.getElementById('help-modal').classList.remove('hidden'); }
function hideHelp() { document.getElementById('help-modal').classList.add('hidden'); }

// å¯åŠ¨
initGame();

</script>
</body>
</html>
